# 后端接口开发提示词（分层与统一返回）

## 目标
- 为后端接口开发提供可直接复用的提示词与落地清单。
- 严格遵循分层约束与统一响应结构，确保可维护、可测试与一致性。

## 分层约束（参考）
- 入口层：`app/routers` 暴露 `/v1/*` 路由，仅做参数校验与统一返回。
- 业务层：`services/*` 承载领域逻辑与跨资源聚合，不直接访问 DB。
- 数据层：`repositories/*` 封装 SQL 与数据读写，函数化原子操作。
- 响应结构：`schemas/responses.py` 定义统一返回体。
- 统一异常：入口层通过全局异常处理器映射为统一结构。

代码参考：
- 统一返回体：`agentlz/schemas/responses.py:4-16`
- 鉴权依赖：`agentlz/app/deps/auth_deps.py:9-31`
- 路由注册与全局异常：`agentlz/app/http_langserve.py:11-13`、`15-25`

## 统一返回结构
- 成功：`Result.ok(data, message="ok", code=0)`
- 失败：`Result.error(message, code, data)`
- 所有接口使用 `response_model=Result`，真实数据置于 `data`。

代码参考：
- `agentlz/schemas/responses.py:4-16`

## 鉴权与租户约束
- 受保护路由通过 `Depends(require_auth)` 强制校验 `Authorization: Bearer <token>`。
- 接口必须校验租户头：`X-Tenant-ID`。

代码参考：
- `agentlz/app/http_langserve.py:12-13`
- `agentlz/app/deps/auth_deps.py:9-31`

## 典型接口（示例）
- 登录：`POST /v1/login`
  - 路由：`agentlz/app/routers/auth.py:18-29`
  - 业务：签发 JWT（8 小时），含 `sub/username/tenant_id/iss/iat/exp`
  - 服务：`agentlz/services/auth_service.py:9-27`
  - 模型：`agentlz/schemas/auth.py`

- 注册：`POST /v1/register`
  - 路由：`agentlz/app/routers/auth.py:38-53`
  - 业务：用户名 + 邮箱查重，创建用户
  - 服务：`agentlz/services/auth_service.py:29-40`
  - 数据：`agentlz/repositories/user_repository.py:78-88`、`91-101`
  - 模型：`agentlz/schemas/auth.py`

## 全局异常处理
- 将 `HTTPException/RequestValidationError/Exception` 映射为 `Result.error`，保持返回体一致性与可观测。

代码参考：
- `agentlz/app/http_langserve.py:15-25`

## 提示词（Prompt）模板
用于新增后端接口时，指导实现遵循分层与统一返回：

```
你是后端接口开发助手，请按如下规范实现一个 /v1/* 接口：

约束：
- 分层：入口(app/routers)→业务(services)→数据(repositories)→响应(schemas)
- 鉴权与租户：受保护接口使用 Depends(require_auth)，校验 X-Tenant-ID
- 返回统一结构：response_model=Result，成功使用 Result.ok(...)，失败使用 Result.error(...)
- 参数校验：使用 pydantic BaseModel 定义请求体/查询参数
- 禁止跨层访问：路由不直接操作数据库，业务不依赖 app，数据层不含业务分支
- 错误处理：业务/数据层返回语义化错误码，入口层统一映射为 HTTP 状态码

输入：
- 接口名称与路径（如 GET /v1/items）
- 请求体/查询参数定义
- 领域逻辑描述（含校验与边界条件）
- 数据访问需求（查询/写入的表与字段）

输出（必须）：
1) 路由函数（app/routers/xxx.py）：
   - 定义 pydantic 请求模型
   - 校验租户头与鉴权（如需）
   - 调用相应 services，返回 Result.ok(...)
2) 业务服务（services/xxx_service.py）：
   - 组合/校验/执行业务逻辑
   - 调用 repositories 获取/写入数据
   - 以语义化错误值或异常回传（供入口层映射）
3) 数据访问（repositories/xxx_repository.py）：
   - 使用参数化 SQL 封装查询/写入函数
   - 保证函数原子性，可复用
4) 响应结构（schemas/...）：
   - 复用已有模型；如需新增实体模型，置于 schemas/

实现细节：
- 统一使用 Result.ok / Result.error
- 所有错误需带明确 code/message
- 对外只暴露 /v1 路由，不泄露内部异常细节
```

## 新增接口落地清单
- 路由：创建/更新 `app/routers/xxx.py`，`response_model=Result`。
- 模型：在 `schemas/` 定义/复用请求与实体模型。
- 服务：在 `services/xxx_service.py` 编写领域逻辑；抛出语义化错误（或返回约定错误码）。
- 仓库：在 `repositories/xxx_repository.py` 编写原子化数据方法。
- 鉴权：受保护接口添加 `Depends(require_auth)`；校验 `X-Tenant-ID`。
- 异常：依赖入口层全局异常处理器统一返回。
- 文档：在 `docs/backend/` 补充接口说明与示例。

## 质量与运行
- 统一样式：`Result` 响应、`X-Tenant-ID` 头、`Authorization` 规范。
- 测试建议：业务层单元测试、路由集成测试（含鉴权/多租户）。
- 运行：`uvicorn agentlz.app.http_langserve:app --port 8000 --reload`。